name: Build, Push AI Image & Deploy

on:
  push:
    branches: [ "main" ]
  workflow_dispatch: {}

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}
  AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
  ECR_REPO: ${{ secrets.ECR_AI_REPO }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set image name
        id: vars
        run: |
          echo "IMAGE_NAME=${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPO }}" >> $GITHUB_ENV

      - name: Build AI image
        run: |
          docker build \
            --build-arg GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }} \
            -t $IMAGE_NAME:latest \
            -t $IMAGE_NAME:${{ github.sha }} \
            .

      - name: Push AI image
        run: |
          docker push $IMAGE_NAME:latest
          docker push $IMAGE_NAME:${{ github.sha }}

  deploy:
    runs-on: ubuntu-latest
    needs: build-and-push # build-and-push ì‘ì—…ì´ ì„±ê³µí•´ì•¼ë§Œ ì‹¤í–‰

    steps:
      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_KEY }}
          script: |
            aws ecr get-login-password --region ${{ secrets.AWS_REGION }} | docker login --username AWS --password-stdin ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com
            
            # 1. 'Deploy' ë¦¬í¬ì§€í† ë¦¬ê°€ cloneëœ í´ë”ë¡œ ì´ë™
            cd /home/ubuntu/matuabom
            
            # 2. 
            # git pull
            
            # 3. ë°©ê¸ˆ ë¹Œë“œëœ ìƒˆ AI ì´ë¯¸ì§€ë¥¼ PULL
            docker compose pull AI
            
            # 4. BE ì„œë¹„ìŠ¤ë§Œ ì¬ì‹œì‘
            docker compose up -d --no-deps --force-recreate AI
            
            # 5. ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” (dangling) ì´ë¯¸ì§€ ì •ë¦¬
            docker image prune -f

  notify:
    runs-on: ubuntu-latest
    needs: [build-and-push, deploy]
    if: always()
    steps:
      - name: Send Discord Notification
        uses: sarisia/actions-status-discord@v1
        if: always()
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK_URL }}
          # ğŸš¨ ì¤‘ìš”: statusì—ëŠ” ë¬´ì¡°ê±´ ì˜ì–´ë§Œ ë“¤ì–´ê°€ì•¼ í•©ë‹ˆë‹¤! (failure, cancelled, success)
          status: ${{ contains(needs.*.result, 'failure') && 'failure' || contains(needs.*.result, 'cancelled') && 'cancelled' || 'success' }}
          
          # âœ… í•œê¸€ ë©”ì‹œì§€ëŠ” ì—¬ê¸°ì— ì ìœ¼ì„¸ìš”
          title: "AI ì„œë²„ ë°°í¬ ${{ contains(needs.*.result, 'failure') && 'ì‹¤íŒ¨ âŒ' || contains(needs.*.result, 'cancelled') && 'ì·¨ì†Œë¨ âš ï¸' || 'ì„±ê³µ âœ…' }}"
          
          description: |
            **ìƒì„¸ ìƒíƒœ:**
            - ë¹Œë“œ: ${{ needs.build-and-push.result }}
            - ë°°í¬: ${{ needs.deploy.result }}
            
            [ì›Œí¬í”Œë¡œìš° í™•ì¸í•˜ê¸°](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          
          # (ì„ íƒ) ìƒ‰ìƒ ì»¤ìŠ¤í…€ (ì„±ê³µ: ì´ˆë¡, ì‹¤íŒ¨: ë¹¨ê°•) - statusê°€ ìë™ìœ¼ë¡œ ì •í•´ì£¼ê¸´ í•˜ì§€ë§Œ ê°•ì œí•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.
          # color: ${{ contains(needs.*.result, 'failure') && '0xff0000' || '0x00ff00' }}
